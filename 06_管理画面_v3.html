<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
      color: white;
      padding: 20px 30px;
    }
    .header h1 { font-size: 24px; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .stat-card h3 { font-size: 14px; color: #666; margin-bottom: 10px; }
    .stat-card .value { font-size: 32px; font-weight: bold; }
    .ok .value { color: #34a853; }
    .borderline .value { color: #ff9800; }
    .ng .value { color: #ea4335; }
    .filters {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .filters label { font-weight: bold; }
    .filters select {
      padding: 8px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
    }
    .refresh-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-left: auto;
    }
    .table-container {
      background: white;
      border-radius: 12px;
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th {
      background: #4285f4;
      color: white;
      padding: 15px 12px;
      text-align: left;
    }
    td { padding: 12px; border-bottom: 1px solid #eee; }
    tr:hover { background: #f8f9fa; }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .badge-ok { background: #e8f5e9; color: #2e7d32; }
    .badge-borderline { background: #fff3e0; color: #ef6c00; }
    .badge-ng { background: #ffebee; color: #c62828; }
    .status-select {
      padding: 6px 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
    }
    .loading, .empty { text-align: center; padding: 60px; color: #666; }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #e0e0e0;
      border-top: 4px solid #4285f4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .desc-cell { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  </style>
</head>
<body>
  <div class="header"><h1>案件管理画面</h1></div>
  <div class="container">
    <div class="stats">
      <div class="stat-card"><h3>総問い合わせ数</h3><div class="value" id="totalCount">-</div></div>
      <div class="stat-card ok"><h3>無料対応OK</h3><div class="value" id="okCount">-</div></div>
      <div class="stat-card borderline"><h3>要ヒアリング</h3><div class="value" id="borderlineCount">-</div></div>
      <div class="stat-card ng"><h3>対応不可</h3><div class="value" id="ngCount">-</div></div>
    </div>
    <div class="filters">
      <label>判定結果:</label>
      <select id="filterJudgment" onchange="applyFilters()">
        <option value="">すべて</option>
        <option value="OK">OK</option>
        <option value="BORDERLINE">BORDERLINE</option>
        <option value="NG">NG</option>
      </select>
      <label>ステータス:</label>
      <select id="filterStatus" onchange="applyFilters()">
        <option value="">すべて</option>
        <option value="未対応">未対応</option>
        <option value="対応中">対応中</option>
        <option value="完了">完了</option>
        <option value="見送り">見送り</option>
      </select>
      <button class="refresh-btn" onclick="loadData()">更新</button>
    </div>
    <div class="table-container">
      <div class="loading" id="loading"><div class="spinner"></div><p>読み込み中...</p></div>
      <div class="empty" id="empty" style="display:none;"><p>問い合わせデータがありません</p></div>
      <table id="dataTable" style="display:none;">
        <thead>
          <tr><th>日時</th><th>会社名</th><th>担当者</th><th>カテゴリ</th><th>判定</th><th>工数</th><th>詳細</th><th>ステータス</th></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  <script>
    var allData = [];

    function loadData() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('dataTable').style.display = 'none';
      document.getElementById('empty').style.display = 'none';

      google.script.run
        .withSuccessHandler(onDataLoaded)
        .withFailureHandler(onError)
        .getInquiries();
    }

    function onDataLoaded(data) {
      allData = data || [];
      document.getElementById('loading').style.display = 'none';

      if (allData.length === 0) {
        document.getElementById('empty').style.display = 'block';
        updateStats([]);
        return;
      }

      document.getElementById('dataTable').style.display = 'table';
      updateStats(allData);
      applyFilters();
    }

    function onError(error) {
      document.getElementById('loading').style.display = 'none';
      alert('エラー: ' + error);
    }

    function updateStats(data) {
      document.getElementById('totalCount').textContent = data.length;
      var okCount = 0, borderlineCount = 0, ngCount = 0;
      for (var i = 0; i < data.length; i++) {
        var j = data[i]['判定結果'] || '';
        if (j === 'OK') okCount++;
        else if (j === 'BORDERLINE') borderlineCount++;
        else if (j.indexOf('NG') !== -1) ngCount++;
      }
      document.getElementById('okCount').textContent = okCount;
      document.getElementById('borderlineCount').textContent = borderlineCount;
      document.getElementById('ngCount').textContent = ngCount;
    }

    function applyFilters() {
      var jf = document.getElementById('filterJudgment').value;
      var sf = document.getElementById('filterStatus').value;
      var filtered = [];
      for (var i = 0; i < allData.length; i++) {
        var d = allData[i];
        var j = d['判定結果'] || '';
        var s = d['ステータス'] || '';
        if (jf && jf !== 'NG' && j !== jf) continue;
        if (jf === 'NG' && j.indexOf('NG') === -1) continue;
        if (sf && s !== sf) continue;
        filtered.push(d);
      }
      renderTable(filtered);
    }

    function renderTable(data) {
      var tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      for (var i = 0; i < data.length; i++) {
        var row = data[i];
        var tr = document.createElement('tr');
        var ts = row['タイムスタンプ'] || '';
        var dateStr = '';
        if (ts) {
          var d = new Date(ts);
          dateStr = d.getFullYear() + '/' + (d.getMonth()+1) + '/' + d.getDate() + ' ' + d.getHours() + ':' + ('0'+d.getMinutes()).slice(-2);
        }
        var j = row['判定結果'] || '';
        var bc = 'badge-ng';
        if (j === 'OK') bc = 'badge-ok';
        else if (j === 'BORDERLINE') bc = 'badge-borderline';
        var m = row['工数(分)'] || 0;
        var h = Math.round(m / 6) / 10;
        var st = row['ステータス'] || '未対応';
        var ri = row['rowIndex'] || 0;
        tr.innerHTML = '<td>' + dateStr + '</td>' +
          '<td>' + (row['会社名']||'') + '</td>' +
          '<td>' + (row['担当者名']||'') + '</td>' +
          '<td>' + (row['カテゴリ']||'') + '</td>' +
          '<td><span class="badge ' + bc + '">' + j + '</span></td>' +
          '<td>' + m + '分(' + h + 'h)</td>' +
          '<td class="desc-cell" title="' + (row['自由記述']||'') + '">' + (row['自由記述']||'') + '</td>' +
          '<td><select class="status-select" onchange="updateStatus(' + ri + ',this.value)">' +
            '<option value="未対応"' + (st==='未対応'?' selected':'') + '>未対応</option>' +
            '<option value="対応中"' + (st==='対応中'?' selected':'') + '>対応中</option>' +
            '<option value="完了"' + (st==='完了'?' selected':'') + '>完了</option>' +
            '<option value="見送り"' + (st==='見送り'?' selected':'') + '>見送り</option>' +
          '</select></td>';
        tbody.appendChild(tr);
      }
    }

    function updateStatus(ri, ns) {
      google.script.run.updateStatus(ri, ns);
    }

    loadData();
  </script>
</body>
</html>
